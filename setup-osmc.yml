---
  - hosts: all
    remote_user: osmc

    vars:

      sshd_config: /etc/ssh/sshd_config
      kodi_gui_settings: /home/osmc/.kodi/userdata/guisettings.xml
      system_user: osmc

    pre_tasks:
    - name: stop kodi
      become: yes
      service: name=mediacenter state=stopped

    tasks:

    # configure sshd

    - name: Place my public ssh key
      authorized_key: user="{{ system_user }}" key="{{ lookup('file', './files/authorized_keys.myuser.pub') }}"
    - name: Disable password login
      become: yes
      replace: dest={{ sshd_config }} regexp="#PasswordAuthentication yes" replace="PasswordAuthentication no"
      notify:
        - restart sshd

    # configure kodi

    - name: switch gui to expert mode
      replace: dest={{ kodi_gui_settings }} regexp="<settinglevel>1</settinglevel>" replace="<settinglevel>3</settinglevel>"
      #notify:
      #  - restart kodi
    - name: use confluence skin
      replace: dest={{ kodi_gui_settings }} regexp="<skin default="true">skin.osmc</skin>" replace="<skin>skin.confluence</skin>"
      #notify:
      #  - restart kodi

    handlers:

    - name: restart sshd
      become: yes
      service: name=sshd state=restarted
    - name: restart kodi
      become: yes
      service: name=mediacenter state=restarted

    post_tasks:
    - name: start kodi
      become: yes
      service: name=mediacenter state=started
