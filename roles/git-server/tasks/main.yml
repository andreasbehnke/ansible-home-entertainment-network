---

  - name: install git
    become: yes
    apt: name=git state=latest
    when: git_repositories is defined

  - name: add git user
    become: yes
    user: name=git shell=/usr/bin/git-shell home=/home/git generate_ssh_key=yes
    when: git_repositories is defined

  #- name: add authorized keys
  #  become: yes
  #  authorized_key: user="git" key="{{ lookup('file', 'authorized_keys.git.pub') }}"
  #  when: git_repositories is defined

  - name: create directories for git repositories
    become: yes
    file: path={{ item }} owner=git group=git mode="0750" state=directory
    with_items: "{{git_repositories}}"
    when: git_repositories is defined

  - name: initialize git repositories
    become: yes
    command: chdir={{ item }} creates={{ item }}/HEAD git init --bare
    with_items: "{{git_repositories}}"
    when: git_repositories is defined

  - name: apply credentials to repositories
    become: yes
    file: path={{ item }} owner=git group=git mode="0750" state=directory recurse=yes
    with_items: "{{git_repositories}}"
    when: git_repositories is defined
